{% assign custom_best_selling = section.id | replace: '_', '' | downcase %}

{% style %}
  .product-grid-{{ custom_best_selling }} {
    display: block;
    width: 100%;
    padding: 40px 0;
  }

  .product-grid-container-{{ custom_best_selling }} {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .product-grid-heading-{{ custom_best_selling }} {
    text-align: center;
    margin-bottom: 40px;
    font-size: 32px;
    font-weight: 700;
    color: #000000;
  }

  .product-grid-items-{{ custom_best_selling }} {
    display: grid;
    grid-template-columns: repeat({{ section.settings.products_per_row_desktop }}, 1fr);
    gap: 24px;
    margin-bottom: 40px;
  }

  @media screen and (max-width: 749px) {
    .product-card-{{ custom_best_selling }} {
      padding: 10px !important;
    }
    .product-grid-items-{{ custom_best_selling }} {
      display: none !important;
    }
  }

  .product-card-{{ custom_best_selling }} {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
    border: 1px solid #D9D9D9;
    padding: 12px 17px;
  }

  .product-card-media-{{ custom_best_selling }} {
    position: relative;
    overflow: hidden;
    margin-bottom: 12px;
    aspect-ratio: 1 / 1;
    background-color: #f5f5f5;
  }

  .product-card-image-{{ custom_best_selling }} {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.3s ease;
  }

  .product-card-image-primary-{{ custom_best_selling }} {
    position: relative;
    z-index: 2;
  }

  .product-card-image-secondary-{{ custom_best_selling }} {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    opacity: 0;
  }

  .product-card-media-{{ custom_best_selling }}:hover .product-card-image-primary-{{ custom_best_selling }} {
    opacity: 0;
  }

  .product-card-media-{{ custom_best_selling }}:hover .product-card-image-secondary-{{ custom_best_selling }} {
    opacity: 1;
  }

  .product-card-badge-{{ custom_best_selling }} {
    position: absolute;
    top: 0px;
    left: 0px;
    background-color: #E3010F;
    color: #ffffff;
    padding: 1px 13px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 800;
    z-index: 3;
  }

  .product-card-info-{{ custom_best_selling }} {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex-grow: 1;
  }

  .product-card-title-{{ custom_best_selling }} {
    font-size: 12px;
    font-weight: 600;
    color: #000000;
    text-decoration: none;
    display: block;
    margin: 0;
  }

  .product-card-title-{{ custom_best_selling }}:hover {
    color: #333333;
  }

  .product-card-meta-{{ custom_best_selling }} {
    font-size: 12px;
    color: #666666;
    background-color: transparent;
    padding: 0px;
    border-radius: 4px;
    display: inline-block;
    width: fit-content;
  }

  .product-card-rating-{{ custom_best_selling }} {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    color: #FFD700;
  }

  .product-card-prices-{{ custom_best_selling }} {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .product-card-price-{{ custom_best_selling }} {
    font-size: 14px;
    font-weight: 600;
    color: #000000;
  }

  .product-card-compare-price-{{ custom_best_selling }} {
    font-size: 12px;
    color: #666666;
    text-decoration: line-through;
  }

  .product-card-form-{{ custom_best_selling }} {
    margin-top: 12px;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .product-card-button-{{ custom_best_selling }} {
    width: 100%;
    padding: 6.5px 24px;
    background-color: #F4FCF8;
    border: 1px solid #00963F;
    border-radius: 0px;
    font-size: 12px;
    color: #333333;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    appearance: button;
  }

  .product-card-button-{{ custom_best_selling }}:hover:not(:disabled) {
    background-color: #00963F;
    color: #fff;
  }

  .product-card-button-{{ custom_best_selling }}:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

  .product-card-bulk-text-{{ custom_best_selling }} {
    font-size: 10px;
    color: #E3010F;
    font-weight: 600;
    text-align: center;
    margin-top: 0px;
  }

  .product-grid-view-all-{{ custom_best_selling }} {
    text-align: center;
    margin-top: 40px;
  }

  .product-grid-view-all-button-{{ custom_best_selling }} {
    display: inline-block;
    padding: 13px 36px;
    background-color: #00963F;
    color: #ffffff;
    text-decoration: none;
    border-radius: 0px;
    font-size: 18px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: background-color 0.3s ease;
  }

  .product-grid-view-all-button-{{ custom_best_selling }}:hover {
    background-color: #333333;
  }

  .product-grid-empty-{{ custom_best_selling }} {
    text-align: center;
    padding: 60px 20px;
    color: #666666;
    font-size: 16px;
  }

  @media (max-width: 767px) {
    .product-grid-view-all-button-{{ custom_best_selling }} {
      font-size: 14px;
    }
  }

  /* ===== MOBILE CAROUSEL ===== */
  .carousel-mobile-{{ custom_best_selling }} {
    display: none;
    position: relative;
  }

  @media screen and (max-width: 749px) {
    .carousel-mobile-{{ custom_best_selling }} {
      display: block;
    }

    .carousel-track-outer-{{ custom_best_selling }} {
      overflow: hidden;
    }

    .carousel-track-{{ custom_best_selling }} {
      display: flex;
      gap: 12px;
      transition: transform 0.35s ease;
    }

    .carousel-slide-{{ custom_best_selling }} {
      flex: 0 0 {% if section.settings.products_per_row_mobile == '1' %}calc(100%){% else %}calc(50% - 6px){% endif %};
      min-width: 0;
    }

    .carousel-arrow-{{ custom_best_selling }} {
      position: absolute;
      top: 38%;
      transform: translateY(-50%);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #D9D9D9;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9;
      padding: 0;
      transition: background 0.2s;
    }
    .carousel-arrow-{{ custom_best_selling }}:hover {
      background: #00963F;
    }
    .carousel-arrow-{{ custom_best_selling }}:hover svg path {
      stroke: #fff;
    }
    .carousel-arrow-{{ custom_best_selling }} svg {
      width: 14px;
      height: 14px;
    }
    .carousel-arrow-{{ custom_best_selling }} svg path {
      stroke: #333;
      stroke-width: 2.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .carousel-arrow-{{ custom_best_selling }}:disabled {
      opacity: 0.25;
      pointer-events: none;
    }
    .carousel-prev-{{ custom_best_selling }} { left: -14px; }
    .carousel-next-{{ custom_best_selling }} { right: -14px; }

    .carousel-dots-{{ custom_best_selling }} {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 14px;
    }
    .carousel-dot-{{ custom_best_selling }} {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #D9D9D9;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: background 0.25s, width 0.25s, border-radius 0.25s;
    }
    .carousel-dot-{{ custom_best_selling }}.active {
      background: #00963F;
      width: 20px;
      border-radius: 4px;
    }
  }

  @media screen and (min-width: 750px) {
    .carousel-mobile-{{ custom_best_selling }},
    .carousel-dots-{{ custom_best_selling }} {
      display: none !important;
    }
  }
{% endstyle %}

{% comment %} Gather related products — exclude current product, deduplicate {% endcomment %}
{% assign rp_shown_ids = '' %}
{% assign rp_shown_count = 0 %}
{% assign rp_limit = 12 %}

<product-grid-{{ custom_best_selling }} class="product-grid-{{ custom_best_selling }}" {{ section.shopify_attributes }}>
  <div class="product-grid-container-{{ custom_best_selling }}">

    {% if section.settings.heading != blank %}
      <h2 class="product-grid-heading-{{ custom_best_selling }}">{{ section.settings.heading }}</h2>
    {% endif %}

    {% if product %}

      {% comment %} ===== DESKTOP GRID ===== {% endcomment %}
      <div class="product-grid-items-{{ custom_best_selling }}">
        {% assign d_shown = '' %}
        {% assign d_count = 0 %}
        {% for col in product.collections %}
          {% for rp in col.products %}
            {% unless rp.id == product.id %}
              {% unless d_shown contains rp.id %}
                {% if d_count < rp_limit %}
                  {% assign d_shown = d_shown | append: rp.id | append: ',' %}
                  {% assign d_count = d_count | plus: 1 %}
                  <div class="product-card-{{ custom_best_selling }}">
                    <div class="product-card-media-{{ custom_best_selling }}">
                      <a href="{{ rp.url }}">
                        {% if rp.featured_image %}
                          <img src="{{ rp.featured_image | image_url: width: 600 }}" alt="{{ rp.featured_image.alt | escape }}" width="600" height="600" loading="lazy" class="product-card-image-{{ custom_best_selling }} product-card-image-primary-{{ custom_best_selling }}">
                        {% else %}
                          <div class="product-card-image-{{ custom_best_selling }} product-card-image-primary-{{ custom_best_selling }}">{{ 'product-1' | placeholder_svg_tag }}</div>
                        {% endif %}
                        {% if rp.images[1] %}
                          <img src="{{ rp.images[1] | image_url: width: 600 }}" alt="{{ rp.images[1].alt | escape }}" width="600" height="600" loading="lazy" class="product-card-image-{{ custom_best_selling }} product-card-image-secondary-{{ custom_best_selling }}">
                        {% endif %}
                      </a>
                      {% if rp.compare_at_price > rp.price %}
                        {% assign disc = rp.compare_at_price | minus: rp.price | times: 100 | divided_by: rp.compare_at_price %}
                        <div class="product-card-badge-{{ custom_best_selling }}">-{{ disc }}%</div>
                      {% endif %}
                    </div>
                    <div class="product-card-info-{{ custom_best_selling }}">
                      {% if section.settings.show_metafield and section.settings.metafield_reference != blank %}
                        <div class="product-card-meta-{{ custom_best_selling }}">{{ section.settings.metafield_reference }}</div>
                      {% endif %}
                      <a href="{{ rp.url }}" class="product-card-title-{{ custom_best_selling }}">{{ rp.title }}</a>
                      {% if section.settings.show_rating %}
                        <div class="product-card-rating-{{ custom_best_selling }}"><span>★★★★★</span></div>
                      {% endif %}
                      <div class="product-card-prices-{{ custom_best_selling }}">
                        <span class="product-card-price-{{ custom_best_selling }}">₹{{ rp.price | divided_by: 100.0 }}</span>
                        {% if rp.compare_at_price > rp.price %}
                          <span class="product-card-compare-price-{{ custom_best_selling }}">₹{{ rp.compare_at_price | divided_by: 100.0 }}</span>
                        {% endif %}
                      </div>
                      {% if rp.available %}
                        <button type="button" class="product-card-button-{{ custom_best_selling }} js-ajax-add-to-cart" data-variant-id="{{ rp.selected_or_first_available_variant.id }}">{{ section.settings.button_text }}</button>
                      {% else %}
                        <button type="button" class="product-card-button-{{ custom_best_selling }}" disabled>Sold Out</button>
                      {% endif %}
                      <div class="product-card-bulk-text-{{ custom_best_selling }}">Discount on Bulk Purchase</div>
                    </div>
                  </div>
                {% endif %}
              {% endunless %}
            {% endunless %}
          {% endfor %}
        {% endfor %}
      </div>

      {% comment %} ===== MOBILE CAROUSEL ===== {% endcomment %}
      {% assign m_shown = '' %}
      {% assign m_count = 0 %}
      <div class="carousel-mobile-{{ custom_best_selling }}">
        <button class="carousel-arrow-{{ custom_best_selling }} carousel-prev-{{ custom_best_selling }}" id="prev-{{ custom_best_selling }}" disabled aria-label="Previous">
          <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div class="carousel-track-outer-{{ custom_best_selling }}">
          <div class="carousel-track-{{ custom_best_selling }}" id="track-{{ custom_best_selling }}">
            {% for col in product.collections %}
              {% for rp in col.products %}
                {% unless rp.id == product.id %}
                  {% unless m_shown contains rp.id %}
                    {% if m_count < rp_limit %}
                      {% assign m_shown = m_shown | append: rp.id | append: ',' %}
                      {% assign m_count = m_count | plus: 1 %}
                      <div class="carousel-slide-{{ custom_best_selling }}">
                        <div class="product-card-{{ custom_best_selling }}">
                          <div class="product-card-media-{{ custom_best_selling }}">
                            <a href="{{ rp.url }}">
                              {% if rp.featured_image %}
                                <img src="{{ rp.featured_image | image_url: width: 400 }}" alt="{{ rp.featured_image.alt | escape }}" width="400" height="400" loading="lazy" class="product-card-image-{{ custom_best_selling }} product-card-image-primary-{{ custom_best_selling }}">
                              {% else %}
                                <div class="product-card-image-{{ custom_best_selling }} product-card-image-primary-{{ custom_best_selling }}">{{ 'product-1' | placeholder_svg_tag }}</div>
                              {% endif %}
                              {% if rp.images[1] %}
                                <img src="{{ rp.images[1] | image_url: width: 400 }}" alt="{{ rp.images[1].alt | escape }}" width="400" height="400" loading="lazy" class="product-card-image-{{ custom_best_selling }} product-card-image-secondary-{{ custom_best_selling }}">
                              {% endif %}
                            </a>
                            {% if rp.compare_at_price > rp.price %}
                              {% assign disc = rp.compare_at_price | minus: rp.price | times: 100 | divided_by: rp.compare_at_price %}
                              <div class="product-card-badge-{{ custom_best_selling }}">-{{ disc }}%</div>
                            {% endif %}
                          </div>
                          <div class="product-card-info-{{ custom_best_selling }}">
                            {% if section.settings.show_metafield and section.settings.metafield_reference != blank %}
                              <div class="product-card-meta-{{ custom_best_selling }}">{{ section.settings.metafield_reference }}</div>
                            {% endif %}
                            <a href="{{ rp.url }}" class="product-card-title-{{ custom_best_selling }}">{{ rp.title }}</a>
                            {% if section.settings.show_rating %}
                              <div class="product-card-rating-{{ custom_best_selling }}"><span>★★★★★</span></div>
                            {% endif %}
                            <div class="product-card-prices-{{ custom_best_selling }}">
                              <span class="product-card-price-{{ custom_best_selling }}">₹{{ rp.price | divided_by: 100.0 }}</span>
                              {% if rp.compare_at_price > rp.price %}
                                <span class="product-card-compare-price-{{ custom_best_selling }}">₹{{ rp.compare_at_price | divided_by: 100.0 }}</span>
                              {% endif %}
                            </div>
                            {% if rp.available %}
                              <button type="button" class="product-card-button-{{ custom_best_selling }} js-ajax-add-to-cart" data-variant-id="{{ rp.selected_or_first_available_variant.id }}">{{ section.settings.button_text }}</button>
                            {% else %}
                              <button type="button" class="product-card-button-{{ custom_best_selling }}" disabled>Sold Out</button>
                            {% endif %}
                            <div class="product-card-bulk-text-{{ custom_best_selling }}">Discount on Bulk Purchase</div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endunless %}
                {% endunless %}
              {% endfor %}
            {% endfor %}
          </div>
        </div>
        <button class="carousel-arrow-{{ custom_best_selling }} carousel-next-{{ custom_best_selling }}" id="next-{{ custom_best_selling }}" aria-label="Next">
          <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </button>
      </div>
      <div class="carousel-dots-{{ custom_best_selling }}" id="dots-{{ custom_best_selling }}"></div>

      {% if section.settings.show_view_all %}
        <div class="product-grid-view-all-{{ custom_best_selling }}">
          <a href="{{ product.collections.first.url }}" class="product-grid-view-all-button-{{ custom_best_selling }}">{{ section.settings.view_all_text }}</a>
        </div>
      {% endif %}

    {% else %}
      <div class="product-grid-empty-{{ custom_best_selling }}">
        This section shows related products on product pages.
      </div>
    {% endif %}

  </div>
</product-grid-{{ custom_best_selling }}>

<script>
  (function() {
    class ProductGrid extends HTMLElement {
      connectedCallback() {
        this.setupAjaxCart();
        this.setupCarousel();
      }

      setupAjaxCart() {
        this.querySelectorAll('.js-ajax-add-to-cart').forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            const variantId = button.dataset.variantId;
            if (!variantId || button.disabled) return;
            const originalText = button.textContent.trim();
            button.disabled = true;
            button.textContent = 'Adding...';

            const sectionIds = Array.from(
              document.querySelectorAll('cart-items-component[data-section-id]')
            ).map(el => el.dataset.sectionId).filter(Boolean);

            const payload = { id: parseInt(variantId), quantity: 1 };
            if (sectionIds.length > 0) { payload.sections = sectionIds.join(','); }

            fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
              if (data.status) {
                button.textContent = data.description || 'Error!';
                setTimeout(() => { button.disabled = false; button.textContent = originalText; }, 2000);
                return;
              }
              button.textContent = 'Added ✓';

              document.dispatchEvent(new CustomEvent('cart:update', {
                bubbles: true,
                detail: { data: { source: 'product-form-component', itemCount: 1, sections: data.sections || {} } }
              }));

              return fetch('/cart.js').then(r => r.json()).then(cart => {
                document.dispatchEvent(new CustomEvent('cart:update', {
                  bubbles: true,
                  detail: { data: { itemCount: cart.item_count, source: 'product-form-component' } }
                }));
                this.updateCartBubble(cart.item_count);
                setTimeout(() => { button.disabled = false; button.textContent = originalText; }, 1500);
              });
            })
            .catch(() => { button.disabled = false; button.textContent = originalText; });
          });
        });
      }

      updateCartBubble(count) {
        document.querySelectorAll('.cart-bubble__text-count, [data-testid="cart-bubble"], .cart-count, #CartCount').forEach(el => {
          el.textContent = count > 99 ? '99+' : count;
          el.classList.remove('hidden');
        });
        const bubble = document.querySelector('.cart-bubble');
        if (bubble) bubble.classList.remove('visually-hidden');
        document.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
        window.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
        const cartDrawer = document.querySelector('cart-drawer');
        if (cartDrawer && typeof cartDrawer.renderContents === 'function') {
          fetch('/?section_id=cart-drawer').then(r => r.text()).then(html => {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const nd = doc.querySelector('cart-drawer');
            if (nd) cartDrawer.innerHTML = nd.innerHTML;
          });
        }
      }

      setupCarousel() {
        var track    = document.getElementById('track-{{ custom_best_selling }}');
        var prevBtn  = document.getElementById('prev-{{ custom_best_selling }}');
        var nextBtn  = document.getElementById('next-{{ custom_best_selling }}');
        var dotsWrap = document.getElementById('dots-{{ custom_best_selling }}');
        if (!track || !prevBtn || !nextBtn || !dotsWrap) return;

        var perView  = parseInt('{{ section.settings.products_per_row_mobile }}') || 2;
        var slides   = Array.from(track.children);
        var total    = slides.length;
        var current  = 0;
        var maxIndex = Math.max(0, total - perView);

        /* Build dots */
        var dots = [];
        for (var i = 0; i <= maxIndex; i++) {
          var d = document.createElement('button');
          d.className = 'carousel-dot-{{ custom_best_selling }}' + (i === 0 ? ' active' : '');
          d.setAttribute('data-index', i);
          d.addEventListener('click', function() { goTo(parseInt(this.getAttribute('data-index'))); });
          dotsWrap.appendChild(d);
          dots.push(d);
        }

        function goTo(index) {
          current = Math.max(0, Math.min(index, maxIndex));
          var slideWidth = slides[0].offsetWidth + 12;
          track.style.transform = 'translateX(-' + (current * slideWidth) + 'px)';
          prevBtn.disabled = current === 0;
          nextBtn.disabled = current >= maxIndex;
          dots.forEach(function(d, i) { d.classList.toggle('active', i === current); });
        }

        prevBtn.addEventListener('click', function() { goTo(current - 1); });
        nextBtn.addEventListener('click', function() { goTo(current + 1); });
        window.addEventListener('resize', function() { goTo(current); });
        goTo(0);
      }
    }

    customElements.define('product-grid-{{ custom_best_selling }}', ProductGrid);
  })();
</script>

{% schema %}
{
  "name": "Related Products",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You May Also Like"
    },
    {
      "type": "range",
      "id": "products_per_row_desktop",
      "label": "Products per row (desktop)",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    },
    {
      "type": "select",
      "id": "products_per_row_mobile",
      "label": "Products per row (mobile carousel)",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show rating stars",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Add to Cart"
    },
    {
      "type": "header",
      "content": "Custom metafield"
    },
    {
      "type": "checkbox",
      "id": "show_metafield",
      "label": "Show metafield",
      "default": false
    },
    {
      "type": "text",
      "id": "metafield_reference",
      "label": "Metafield reference",
      "info": "Connect using dynamic source picker to select product metafield"
    },
    {
      "type": "header",
      "content": "View all button"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show view all button",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "Button text",
      "default": "VIEW ALL RELATED PRODUCTS"
    }
  ],
  "presets": [
    {
      "name": "Related Products"
    }
  ]
}
{% endschema %}
